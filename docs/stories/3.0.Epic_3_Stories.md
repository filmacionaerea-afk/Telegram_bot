# Epic 3: Análisis y Síntesis de Narrativas con IA

**Goal:** Desarrollar el servicio de análisis que transforma los datos crudos en inteligencia procesable, generando narrativas, sentimientos y probabilidades, y almacenando los resultados en la base de datos.

## Story 3.1: Implementación del Servicio de Análisis
* **As a** developer, **I want** a new `analyzer` service within the monorepo, **so that** I can house all logic related to data processing and AI analysis.
* **Acceptance Criteria:**
    1.  A new `analyzer` application is created within the `apps/` directory.
    2.  The service has access to the central configuration and the database.
    3.  A mechanism is established to track the timestamp of the last analysis run.

## Story 3.2: Recuperación de Datos Nuevos para Análisis
* **As an** analyzer service, **I want** to retrieve all posts added since my last run, **so that** I can process only new and relevant information.
* **Acceptance Criteria:**
    1.  A function queries the timestamp of the last analysis.
    2.  The function retrieves all records from the `Posts` table newer than that timestamp.

## Story 3.3: Identificación de la Narrativa del Día
* **As an** analyzer service, **I want** to send the content of new posts to the analysis API, **so that** I can identify the main narrative of the day and its associated sentiment.
* **Acceptance Criteria:**
    1.  A function invokes the analysis API with the new content and the `narrative_prompt.txt`.
    2.  The function invokes the analysis API a second time with the `sentiment_prompt.txt`.
    3.  The results (narrative summary and sentiment) are saved to the `DailyNarratives` table.

## Story 3.4: Cálculo de Probabilidad y Narrativas Emergentes
* **As an** analyzer service, **I want** to send historical and current context to the analysis API, **so that** I can calculate the probability of the current narrative and identify 5 emerging narratives.
* **Acceptance Criteria:**
    1.  A function retrieves historical narratives from the database.
    2.  The function invokes the analysis API with the required context and the `probability_prompt.txt`.
    3.  The probability score is saved to the `NarrativeProbabilities` table.
    4.  The 5 emerging narratives are saved as new entries in the `DailyNarratives` and `NarrativeProbabilities` tables.

## Story 3.5: Orquestación y Programación del Cron Job de Análisis
* **As a** system, **I need** the entire analysis process to run automatically, **so that** market intelligence is generated regularly.
* **Acceptance Criteria:**
    1.  The main script orchestrates the sequence of analysis steps.
    2.  The script updates the timestamp of the last analysis run.
    3.  The process is scheduled as a cron job based on the `ANALYSIS_INTERVAL` environment variable.
